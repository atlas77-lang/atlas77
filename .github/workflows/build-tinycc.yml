name: Build TinyCC Pre-built Binaries

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - 'vendor/tinycc/**'
      - '.github/workflows/build-tinycc-prebuilt.yml'

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # ⭐ THIS IS CRITICAL!
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-mingw-w64-x86-64
      
      - name: Build Linux x86_64
        run: |
          cd vendor/tinycc
          ./configure --cpu=x86_64 --disable-shared --enable-static
          make -j$(nproc)
          mkdir -p prebuilt/linux-x64
          cp libtcc.a libtcc1.a prebuilt/linux-x64/
          make clean
          rm -f config.mak config.h
      
      - name: Build Windows x86_64 (cross-compile)
        run: |
          cd vendor/tinycc
          ./configure --cpu=x86_64 --cross-prefix=x86_64-w64-mingw32- --disable-shared --enable-static
          make -j$(nproc)
          mkdir -p prebuilt/windows-x64
          cp libtcc.a libtcc1.a prebuilt/windows-x64/
          make clean
          rm -f config.mak config.h
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tinycc-linux-windows
          path: vendor/tinycc/prebuilt/
          retention-days: 90

  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # ⭐ THIS IS CRITICAL!
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Build ARM64 using Docker
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace/vendor/tinycc \
            arm64v8/ubuntu:22.04 \
            bash -c "
              apt-get update && 
              apt-get install -y build-essential &&
              ./configure --cpu=arm64 --disable-shared --enable-static &&
              make -j\$(nproc) &&
              mkdir -p prebuilt/linux-arm64 &&
              cp libtcc.a libtcc1.a prebuilt/linux-arm64/
            "
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tinycc-linux-arm64
          path: vendor/tinycc/prebuilt/
          retention-days: 90

  build-macos:
    strategy:
      matrix:
        include:
          - os: macos-13      # Intel
            arch: x64
            cpu: x86_64
          - os: macos-14      # Apple Silicon
            arch: arm64
            cpu: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # ⭐ THIS IS CRITICAL!
      
      - name: Build macOS ${{ matrix.arch }}
        run: |
          cd vendor/tinycc
          ./configure --cpu=${{ matrix.cpu }} --disable-shared --enable-static
          make -j$(sysctl -n hw.ncpu)
          mkdir -p prebuilt/macos-${{ matrix.arch }}
          cp libtcc.a libtcc1.a prebuilt/macos-${{ matrix.arch }}/
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tinycc-macos-${{ matrix.arch }}
          path: vendor/tinycc/prebuilt/
          retention-days: 90

  # Combine all artifacts and create a commit
  commit-prebuilt:
    needs: [build-linux-x64, build-linux-arm64, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Only auto-commit on manual trigger
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Copy artifacts to vendor/tinycc/prebuilt
        run: |
          mkdir -p vendor/tinycc/prebuilt
          cp -r artifacts/tinycc-linux-windows/* vendor/tinycc/prebuilt/ || true
          cp -r artifacts/tinycc-linux-arm64/* vendor/tinycc/prebuilt/ || true
          cp -r artifacts/tinycc-macos-x64/* vendor/tinycc/prebuilt/ || true
          cp -r artifacts/tinycc-macos-arm64/* vendor/tinycc/prebuilt/ || true
      
      - name: Create README in prebuilt directory
        run: |
          cat > vendor/tinycc/prebuilt/README.md << 'EOF'
          # Pre-built TinyCC Binaries
          
          These are pre-built static libraries of TinyCC for common platforms.
          
          ## Platforms
          
          - `linux-x64/` - Linux x86_64
          - `linux-arm64/` - Linux ARM64
          - `windows-x64/` - Windows x86_64
          - `macos-x64/` - macOS x86_64 (Intel)
          - `macos-arm64/` - macOS ARM64 (Apple Silicon)
          